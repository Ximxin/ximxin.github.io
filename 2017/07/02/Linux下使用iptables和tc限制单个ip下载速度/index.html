<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="西门信"><link rel="alternative" href="/atom.xml" title="西门信's Blog" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Linux下使用iptables和tc限制单个ip下载速度 - 西门信's Blog</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0;"><header class="head"><h1 class="head-title u-fl"><a href="/">西门信's Blog</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">Please Onclick.(请点击食用)</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2017-07-02T10:57:22.000Z">July 2, 2017</time><h1 class="post__title"><a href="/2017/07/02/Linux下使用iptables和tc限制单个ip下载速度/">Linux下使用iptables和tc限制单个ip下载速度</a></h1><div class="post__main echo"><p>linux下使用iptables和tc限制速度的方法，记录一下。假设本地搭建了PPTPD服务，又或者有多个网卡，需要对其中一些接口做限速处理的情况，非常有用，本文基于CentOS 6.4 64bit。</p>
<h3 id="1、初始配置"><a href="#1、初始配置" class="headerlink" title="1、初始配置"></a>1、初始配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br><span class="line"><span class="comment">#找到net.ipv4.ip_forward = 0修改net.ipv4.ip_forward = 1;没有就添加一行。</span></span><br><span class="line">sysctl -p</span><br><span class="line"> </span><br><span class="line"><span class="comment">#清除原来的mangle表规则</span></span><br><span class="line">iptables -t mangle -F</span><br><span class="line"> </span><br><span class="line"><span class="comment">#加载sch_htb模块</span></span><br><span class="line">modprobe sch_htb</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"modprobe sch_htb"</span> &gt;&gt; /etc/rc.local</span><br></pre></td></tr></table></figure>
<h3 id="2、TC限速设置"><a href="#2、TC限速设置" class="headerlink" title="2、TC限速设置"></a>2、TC限速设置</h3><p>假设现在有两块网卡<br>eth0: xx.xx.xx.xx（外网的上网地址）<br>eth1: 172.16.44.1（做为内网的网关）</p>
<h3 id="下载限速"><a href="#下载限速" class="headerlink" title="下载限速"></a>下载限速</h3><p>下载限速要在eth1上面做，判断数据包的目的地址来做限制。tc包括三部分：队列、类、过滤器。我使用了htb方式去限制速度，也可以使用cbq，但cbq配置比较复杂一点，而且据说性能没htb好。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除原来的tc规则队列</span></span><br><span class="line">/sbin/tc qdisc del dev eth1 root</span><br><span class="line"><span class="comment">#添加tc规则队列</span></span><br><span class="line">/sbin/tc qdisc add dev eth1 root handle 10: htb default 256</span><br><span class="line"><span class="comment">#生成根类</span></span><br><span class="line">/sbin/tc class add dev eth1 parent 10: classid 10:1 htb rate 100mbit ceil 100mbit</span><br><span class="line"><span class="comment">#支类列表用于限制速度</span></span><br><span class="line"><span class="comment">#这里的rate指的是保证带宽,ceil是最大带宽。</span></span><br><span class="line">/sbin/tc class add dev eth1 parent 10:1 classid 10:10 htb rate 400kbps ceil 400kbps prio 1</span><br><span class="line"> </span><br><span class="line"><span class="comment">#添加支类规则队列</span></span><br><span class="line"><span class="comment">#采用sfq伪随机队列，并且10秒重置一次散列函数。</span></span><br><span class="line">/sbin/tc qdisc add dev eth1 parent 10:10 handle 101: sfq perturb 10</span><br><span class="line"> </span><br><span class="line"><span class="comment">#建立网络包过滤器，设置fw。</span></span><br><span class="line">/sbin/tc filter add dev eth1 parent 10: protocol ip prio 10 handle 1 fw classid 10:10</span><br></pre></td></tr></table></figure>
<p>在iptables里面设定mark值，与上面的handle值对应</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t mangle -A POSTROUTING -d 172.16.44.130 -j MARK --<span class="built_in">set</span>-mark 1</span><br><span class="line">iptables -t mangle -A POSTROUTING -d 172.16.44.130 -j RETURN</span><br></pre></td></tr></table></figure>
<p>通过上面的代码就可以限制172.16.44.130这台机子的下载速度到400kbps。</p>
<p>需要注意的是：<br>1，172.16.44.130也可以写成网段的形式，例如172.16.44.0/24<br>2，这里的kbps实际上就是KB/S（每秒千字节），另一个单位是kbit，这个才是每秒千比特。</p>
<h3 id="上传限速"><a href="#上传限速" class="headerlink" title="上传限速"></a>上传限速</h3><p>上传限速的原理其实跟下载的差不多，只不过限制的网卡不同，要在eth0上过滤来源地址去限制。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除原来的tc规则队列</span></span><br><span class="line">tc qdisc del dev eth0 root</span><br><span class="line"> </span><br><span class="line"><span class="comment">#添加tc规则队列</span></span><br><span class="line">tc qdisc add dev eth0 root handle 20: htb default 256</span><br><span class="line"> </span><br><span class="line"><span class="comment">#生成根类</span></span><br><span class="line">tc class add dev eth0 parent 20: classid 20:1 htb rate 100mbit ceil 100mbit</span><br><span class="line"> </span><br><span class="line"><span class="comment">#支类列表用于限制速度</span></span><br><span class="line">tc class add dev eth0 parent 20:1 classid 20:10 htb rate 40kbps ceil 40kbps prio 1</span><br><span class="line"> </span><br><span class="line"><span class="comment">#添加支类规则队列</span></span><br><span class="line">tc qdisc add dev eth0 parent 20:10 handle 201: sfq perturb 10</span><br><span class="line"> </span><br><span class="line"><span class="comment">#建立网络包过滤器</span></span><br><span class="line">tc filter add dev eth0 parent 20: protocol ip prio 100 handle 2 fw classid 20:10</span><br><span class="line">iptables -t mangle -A PREROUTING -s 172.16.44.130 -j MARK --<span class="built_in">set</span>-mark 2</span><br><span class="line">iptables -t mangle -A PREROUTING -s 172.16.44.130 -j RETURN</span><br></pre></td></tr></table></figure>
<p>跟下载不同的是POSTROUTING要改成PREROUTING，-d改成-s。</p>
<p>本文转载：<br><a href="https://www.zhukun.net/archives/7401" target="_blank" rel="noopener">linux下使用iptables和tc限制速度</a></p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/Linux/">Linux</a></li></ul></footer></article><section class="reward"> <a class="btn-reward" href="#">打赏</a><div class="reward-wrapper clearfix"><img src="/img/wechat.png" title="微信"></div></section><div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC8zMjMyNi84ODg3"><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2017 西门信</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>